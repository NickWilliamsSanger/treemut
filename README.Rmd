---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  echo=TRUE
)
library(treemut)
```
### Overview 
Code implementing maximum likelihood assignment of mutations to trees.  The method uses an EM method to soft assign mutations to branches and simultaneously estimate branch lengths.

### Algorithm
Each mutation is assigned to branch with probability:

P(Mutation has genotype ) ~ P(Read Count | genotype)P(genotype)

Where a given branch implies a genotype and P(genotype) is proportional to branch length.  The read counts are modelled using the binomial distribution with up to 4 distinct per sample specific error rates and an assumed VAF=0.5 for variant sites and VAF=0 for wild type sites.

## Installation
```r
library(devtools)
install_git("https://github.com/nangalialab/treemut")
```

## Example usage

### Generate tree
```{r}
tree=generate_random_tree(50)
plot(tree)
```

Note that the tree includes an outgroup "zeros".  This can be added to a tree obtained from other sources by
```{r eval=FALSE}
tree=bind.tree(tree,read.tree(text="(zeros:0);"))
```

Now we create a summary object that summarises each branch of the tree as a genotype (1's for samples that share the branch and 0's for the rest).  This just requires the APE tree as input:
```{r}
  df=reconstruct_genotype_summary(tree)
cat(df$samples,"\n")
head(df$df[, 1:3])
```



Where

* "profile" column indicates the genotype (in the same order as df sample)
* "edge\_length" gives the branch edge length i.e. number of mutations assigned to branch (perfectly known here)
* "mut\_count"  Indicates the number of mutant samples implied by the genotype (i.e. the number of 1s in "profile")


We now simulate some data based on the tree:

```{r}
 simdat=simulate_reads_from_tree(df,12)
head(simdat$mtr)
head(simdat$depth)
print(simdat$p.error)
```

We now have required information: mutant read matrix "mtr", depth matrix "depth", genotype summary "df",and base calling error rate "p.error" - note how we've set the last entry corresponding to "zeros" outgroup very low.

```{r dev.args=list(pointsize=12),fig.height=8,fig.width=12}
 res=assign_to_tree(tree,simdat$mtr,simdat$depth,error_rate=simdat$p.error)
tree_estimated=res$tree
par(mfcol=c(1,2))
plot(ladderize(tree,right=TRUE),cex=0.5)
plot(ladderize(tree_estimated,right=TRUE),cex=0.5)
```


```{r dev.args=list(pointsize=12),fig.height=12,fig.width=12}
sim=list(edge_length_orig=df$df$edge_length,
         edge_length_inferred=res$df$df$edge_length,
         expected_edge_length_inferred=res$df$df$expected_edge_length,
         edge_idx_orig=simdat$edge,
         edge_idx_ml=res$summary$edge_ml)
plot_sim_result(sim)
```

\section{Specifying an alternative VAF}


